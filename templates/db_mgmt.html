{% extends "base.html" %}

{% block title %}Database Stats{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; margin-top: -1.25rem; margin-bottom: 1.25rem">
    <div style="display: flex; gap: 0.5rem;">
        <a href="/" class="btn-nav">Bundle Editor</a>
        <a href="/social" class="btn-nav">Social Posting</a>
    </div>
    <h2 style="margin: 0; flex: 1; text-align: center; font-family: var(--font-body)">Database Stats</h2>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button type="button" id="btn-sveltiacms-check" class="btn-nav">Check SveltiaCMS</button>
        {% if sveltiacms_count > 0 %}
        <a href="/?sveltiacms=1" class="btn-nav">Add Next Site ({{ sveltiacms_count }})</a>
        {% endif %}
    </div>
</div>

<!-- SveltiaCMS Modal -->
<div id="sveltiacms-modal" class="deploy-modal-overlay" style="display: none;">
    <div class="deploy-modal" style="max-width: 600px;">
        <h3>New SveltiaCMS Showcase Sites</h3>
        <div id="sveltiacms-modal-body" style="flex: 1; overflow-y: auto; max-height: 50vh;">
            <label style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.75rem; font-weight: 700; font-size: 0.85rem;">
                <input type="checkbox" id="sveltiacms-select-all" checked style="margin: 0;">
                Select All
            </label>
            <div id="sveltiacms-site-list" class="sveltiacms-site-list"></div>
        </div>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem;">
            <button type="button" id="sveltiacms-cancel" class="btn-action" style="background: var(--pico-secondary); border-color: var(--pico-secondary);">Cancel</button>
            <button type="button" id="sveltiacms-save" class="btn-action">Save Sites</button>
        </div>
    </div>
</div>

<div class="dbmgmt-container">

    <!-- Database Statistics -->
    <fieldset class="dbmgmt-section">
        <legend>Database Statistics</legend>
        <div class="dbmgmt-stats-grid">
            <div>
                <h4>bundledb.json</h4>
                <table class="dbmgmt-stats-table">
                    <tr><td>Total entries</td><td>{{ "{:,}".format(stats.total) }}</td></tr>
                    <tr><td>Blog Posts</td><td>{{ "{:,}".format(stats.types.get('blog post', 0)) }}</td></tr>
                    <tr><td>Sites</td><td>{{ "{:,}".format(stats.types.get('site', 0)) }}</td></tr>
                    <tr><td>Releases</td><td>{{ "{:,}".format(stats.types.get('release', 0)) }}</td></tr>
                    <tr><td>Starters</td><td>{{ "{:,}".format(stats.types.get('starter', 0)) }}</td></tr>
                    <tr><td>Unique authors</td><td>{{ "{:,}".format(stats.authors) }}</td></tr>
                    <tr><td>Categories</td><td>{{ "{:,}".format(stats.categories) }}</td></tr>
                </table>
            </div>
            <div>
                <h4>showcase-data.json</h4>
                <table class="dbmgmt-stats-table">
                    <tr><td>Total entries</td><td>{{ "{:,}".format(stats.showcase_total) }}</td></tr>
                </table>
            </div>
        </div>
    </fieldset>

    <!-- Backup Files -->
    <fieldset class="dbmgmt-section">
        <legend>Backup Files</legend>
        <div class="dbmgmt-stats-grid">
            <div>
                <h4>bundledb backups</h4>
                <table class="dbmgmt-stats-table">
                    <tr><td>Backup count</td><td>{{ backup_info.bundledb.count }}</td></tr>
                    <tr><td>Latest backup</td><td>{{ backup_info.bundledb.latest or 'None' }}</td></tr>
                    <tr><td>Oldest backup</td><td>{{ backup_info.bundledb.oldest or 'None' }}</td></tr>
                </table>
            </div>
            <div>
                <h4>showcase-data backups</h4>
                <table class="dbmgmt-stats-table">
                    <tr><td>Backup count</td><td>{{ backup_info.showcase.count }}</td></tr>
                    <tr><td>Latest backup</td><td>{{ backup_info.showcase.latest or 'None' }}</td></tr>
                    <tr><td>Oldest backup</td><td>{{ backup_info.showcase.oldest or 'None' }}</td></tr>
                </table>
            </div>
        </div>
    </fieldset>

    <!-- Recent Git Commits -->
    <fieldset class="dbmgmt-section">
        <legend>Recent Git Commits</legend>
        <div class="dbmgmt-commits-grid">
            <div>
                <h4>bundledb.json</h4>
                <div id="bundledb-commits">Loading commits...</div>
            </div>
            <div>
                <h4>showcase-data.json</h4>
                <div id="showcase-commits">Loading commits...</div>
            </div>
        </div>
    </fieldset>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/db_mgmt.js') }}?v={{ dbmgmt_js_version }}"></script>
{% endblock %}
